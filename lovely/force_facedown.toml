[manifest]
version = "1.0.0"
priority = 0

#
# Patch to let jokers force facedown draws, rather than just bosses
#

# CardArea:emplace()
[[patches]]
[patches.pattern]
target = "cardarea.lua"
pattern = '''
if card.facing == 'back' and self.config.type ~= 'discard' and self.config.type ~= 'deck' and not stay_flipped then
    card:flip()
end'''
position = "at"
payload = '''
if card.facing == 'back' and self.config.type ~= 'discard' and self.config.type ~= 'deck' then
    if card.ability.wheel_flipped then 
        card.ability.played_while_flipped = true
    end
    if not stay_flipped then
        card:flip()
    end
end'''
match_indent = true
times = 1


# CardArea:emplace()
[[patches]]
[patches.pattern]
target = "cardarea.lua"
pattern = '''local stay_flipped = G.GAME and G.GAME.blind and G.GAME.blind:stay_flipped(self, card, area)'''
position = "at"
payload = '''local stay_flipped = (G.GAME and G.GAME.blind and G.GAME.blind:stay_flipped(self, card, area)) or card.joker_force_facedown'''
match_indent = true
times = 1


# draw_card()
[[patches]]
[patches.pattern]
target = "functions/common_events.lua"
pattern = '''local stay_flipped = G.GAME and G.GAME.blind and G.GAME.blind:stay_flipped(to, card, from)'''
position = "at"
payload = '''local stay_flipped = (G.GAME and G.GAME.blind and G.GAME.blind:stay_flipped(to, card, from)) or card.joker_force_facedown'''
match_indent = true
times = 1